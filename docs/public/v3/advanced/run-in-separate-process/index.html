
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the wp-browser WordPress testing framework.">
      
      
        <meta name="author" content="Luca Tumedei">
      
      
        <link rel="canonical" href="https://wpbrowser.wptestkit.dev/v3/advanced/run-in-separate-process/">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.20">
    
    
      
        <title>Run in separate process - wp-browser docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#running-tests-in-separate-processes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="wp-browser docs" class="md-header__button md-logo" aria-label="wp-browser docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wp-browser docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Run in separate process
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lucatume/wp-browser/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="wp-browser docs" class="md-nav__button md-logo" aria-label="wp-browser docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wp-browser docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lucatume/wp-browser/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Start here
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-tests-in-separate-processes" class="md-nav__link">
    Running tests in separate processes
  </a>
  
    <nav class="md-nav" aria-label="Running tests in separate processes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-run-tests-in-a-separate-php-process" class="md-nav__link">
    Why run tests in a separate PHP process?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-tests-in-separate-php-processes" class="md-nav__link">
    Running tests in separate PHP processes
  </a>
  
    <nav class="md-nav" aria-label="Running tests in separate PHP processes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#can-i-run-some-tests-in-the-same-process-and-some-in-a-separate-process" class="md-nav__link">
    Can I run some tests in the same process and some in a separate process?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oop-refactoring-of-get_api" class="md-nav__link">
    OOP refactoring of get_api
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Run in separate process</h1>

<h2 id="running-tests-in-separate-processes">Running tests in separate processes</h2>
<p>PHPUnit offers the possibility to run tests <a href="https://phpunit.readthedocs.io/en/9.2/annotations.html?highlight=separate#runtestsinseparateprocesses">in a separate PHP process</a>; Codeception does not officially support the option as of version 4.0.</p>
<p>The wp-browser project tries to fill that gap by supporting the <code>@runInSeparateProcess</code> annotation.<br />
This support comes with some caveats, though:</p>
<ol>
<li>The support is only for test cases extending the <code>Codeception\TestCase\WPTestCase</code> class (the base test case for integration or "WordPress unit" tests)</li>
<li>The support wp-browser provides only supports the <code>@preserveGlobalState</code> annotation with the <code>disabled</code> value; this means there is no support for preserving global state between tests.</li>
</ol>
<p>Read more about what this means in PHPUnit documentation.</p>
<h3 id="why-run-tests-in-a-separate-php-process">Why run tests in a separate PHP process?</h3>
<p>One main reason: isolation.</p>
<p>What does "isolation" means?</p>
<p>Before answering that question, it's essential to understand, via an example, why a lack of isolation might be an issue.</p>
<p>I want to test the <code>get_api</code> function. The function will return the correct singleton instance of an API handling class: an instance of <code>Api</code> when the function is called in non-admin context, and an instance of <code>AdminApi</code> when the function is called in admin context. The <code>get_api</code> function is acting as a service locator.</p>
<pre><code class="language-php">&lt;?php
function get_api(){
    static $api;

    if(null !== $api){
        return $api;
    }

    if( is_admin() ) {
        $api = new Admin_Api();
    } else {
        $api = new Api();
    }

    return $api;
}
</code></pre>
<p>There are two challenges to testing this function:</p>
<ol>
<li>The <code>is_admin</code> function, defined by WordPress, looks up a <code>WP_ADMIN</code> constant to know if the context of the current request is an administration UI one or not.</li>
<li>The <code>get_api</code> function will check for the context and resolve and build the correct instance only once, the first time it's called in the context of a request. </li>
</ol>
<p>There are some possible solutions to this problem:</p>
<p>a. Refactor the <code>get_api</code> function into a method of an <code>Api_Factory</code> object taking the context as a dependency, thus allowing injection of the "context" (which implies the creation of a Context adapter that will proxy its <code>is_admin</code> method to the <code>is_admin</code> function). You can find the code for such refactoring in the <a href="#oop-refactoring-of-get_api">OOP refactoring of get_api</a> section.
b. Refactor the <code>get_api</code> function to accept the current <code>is_admin</code> value as an input argument, <code>get_api( $is_admin )</code>, this refactoring moves part of the complexity of getting hold of the correct instance of the API handler on the client code. Adding more build condition and checks, e.g., if the current request is a REST request or not or some tests on the user authorizations, then, requires adding more input arguments to the <code>get_api</code> function: the knowledge of the implementation of the <code>get_api</code> method will "leak" to the client code having to replicate complexity throughout the system.</p>
<p>I want to layout possible solutions to the problem to show there is <strong>always</strong> a design alternative to make code testable that might or might not fit the current time or scope constraint.  </p>
<p>In this example, I've inherited the <code>get_api</code> function from the existing code, and it cannot be changed, yet I want to test it dealing with the two problems outlined above.</p>
<h3 id="running-tests-in-separate-php-processes">Running tests in separate PHP processes</h3>
<p>To test the <code>get_api</code> function shown above I've created a new <code>wpunit</code> type of test:</p>
<pre><code class="language-bash">vendor/bin/codecept g:wpunit integration &quot;api&quot;
</code></pre>
<p>The command scaffolds a <code>test/integration/apiTest.php</code> file that I've modified to ensure full coverage of the <code>get_api</code> function:</p>
<pre><code class="language-php">&lt;?php

class apiTest extends \Codeception\TestCase\WPTestCase
{
    public function test_get_api_exists()
    {
        $this-&gt;assertTrue(function_exists('get_api'));
    }

    public function test_get_api_will_cache()
    {
        $this-&gt;assertSame(get_api(), get_api());
    }

    /**
     * @runInSeparateProcess
     * @preserveGlobalState disabled
     */
    public function test_get_api_will_return_api_if_not_admin()
    {
        // Let's make sure we're NOT in admin context.
        define('WP_ADMIN', false);

        $api = get_api();

        $this-&gt;assertInstanceOf(Api::class, $api);
    }

    /**
     * @runInSeparateProcess
     * @preserveGlobalState disabled
     */
    public function test_get_api_will_cache_api_if_not_admin()
    {
        // Let's make sure we're NOT in admin context.
        define('WP_ADMIN', false);

        $api = get_api();

        $this-&gt;assertSame(get_api(), $api);
    }

    /**
     * @runInSeparateProcess
     * @preserveGlobalState disabled
     */
    public function test_get_api_will_return_api_if_is_admin()
    {
        // Let's make sure we're NOT in admin context.
        define('WP_ADMIN', true);

        $api = get_api();

        $this-&gt;assertInstanceOf(AdminApi::class, $api);
    }

    /**
     * @runInSeparateProcess
     * @preserveGlobalState disabled
     */
    public function test_get_api_will_cache_api_if_is_admin()
    {
        // Let's make sure we're NOT in admin context.
        define('WP_ADMIN', true);

        $api = get_api();

        $this-&gt;assertSame(get_api(), $api);
    }
}
</code></pre>
<p>Some pieces of this code are worth pointing out:</p>
<ol>
<li>There are two test methods, <code>test_get_api_exists</code> and <code>test_get_api_will_cache</code> that are <strong>not</strong> running in a separate process. Running tests in a separate process provide isolation at the cost of speed, <strong>only tests that require isolation should run in a separate PHP process</strong>.  </li>
<li>I instruct the Codeception and PHPUnit test runner to run a test method in a different process by adding two annotations that are both required <strong> precisely as shown</strong>:
    ```php
    /**<ul>
<li>@runInSeparateProcess</li>
<li>@preserveGlobalState disabled
 */
```</li>
</ul>
</li>
<li>The isolation part of this testing approach shines through when I <code>define</code>, in the last four tests, the <code>WP_ADMIN</code> constant multiple times. If I try to do that in test code running in the same PHP process, then the second <code>define</code> call would cause a fatal error.</li>
<li>The isolation has also taken care of the second issue where the <code>get_api</code> function caches the <code>$api</code> instance after its first resolution in a <code>static</code> variable: since each test happens in a self-contained, dedicated PHP process, the <code>static $api</code> variable will be <code>null</code> at the start of each test.</li>
</ol>
<h4 id="can-i-run-some-tests-in-the-same-process-and-some-in-a-separate-process">Can I run some tests in the same process and some in a separate process?</h4>
<p>Yes. In the example test code in the previous section, the <code>test_get_api_exists</code> and <code>test_get_api_will_cache</code> test methods are not running in separate processes.  </p>
<p>In your test cases extending the <code>Codeception\TestCase\WPTestCase</code>, you can mix test methods running in the primary PHP process and those running in a separate PHP process without issues.</p>
<h3 id="oop-refactoring-of-get_api">OOP refactoring of get_api</h3>
<p>In the <a href="#why-run-tests-in-separate-process">Why run tests in a separate PHP process?</a> section I've outlined a possible refactoring of the <code>get_api</code> function to make it testable without requiring the use of separate PHP processes.</p>
<p>I'm providing this refactoring code below for the sake of completeness, the judgment of which approach is "better" is up to the reader.</p>
<pre><code class="language-php">&lt;?php

class Context_Adapter{

    public function is_admin(){
        return \is_admin();
    }

}

class Api_Factory{

    private $api;
    private $context;

    public function __construct(Context_Adapter $context){
        $this-&gt;context = $context;
    }

    public function getApi(){
        if(null !== $this-&gt;api){
            return $this-&gt;api;    
        }

        if($this-&gt;context-&gt;is_admin()){
            $api = new Admin_Api;
        } else {
            $api = new Api;
        }

        return $api;
    }
}
</code></pre>
<p>Now the <code>Api_Factory</code> class can be injected by injecting a mocked <code>Context_Adapter</code> class, modifying the return value of the <code>Context_Adapter::is_admin</code> method.  </p>
<p>Due to the supposed requirement of the API instance being a singleton, this solution will also require some container or service-locator to ensure at most only one instance of the <code>Api_Factory</code> exists at any given time in the context of a request.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>